#!/usr/bin/env python3
import os, sys, json, platform, argparse, zipfile, shutil, urllib.request, urllib.error, io, ssl

REPO_URL = "https://raw.githubusercontent.com/LightingDev/cheese-repo/main/index.json"
CHEESE_CLI_URL = "https://raw.githubusercontent.com/LightingDev/cheese/main/cheese"

CHEESE_HOME = os.path.join(os.path.expanduser("~"), ".cheese")
PACKAGES_DIR = os.path.join(CHEESE_HOME, "packages")
BIN_DIR = os.path.join(CHEESE_HOME, "bin")
INSTALLED_FILE = os.path.join(CHEESE_HOME, "installed.json")
CLI_PATH = os.path.join(BIN_DIR, "cheese")

for d in (CHEESE_HOME, PACKAGES_DIR, BIN_DIR):
    os.makedirs(d, exist_ok=True)

if not os.path.exists(INSTALLED_FILE):
    with open(INSTALLED_FILE, "w") as f:
        json.dump({}, f)

def echo(msg):
    print(msg, flush=True)

def get_platform_key():
    sysname = platform.system().lower()
    if "windows" in sysname: return "windows"
    if "darwin" in sysname: return "darwin"
    return "linux"

def load_installed():
    with open(INSTALLED_FILE, "r") as f:
        return json.load(f)

def save_installed(data):
    with open(INSTALLED_FILE, "w") as f:
        json.dump(data, f, indent=2)

def fetch_url(url):
    import ssl
    try:
        with urllib.request.urlopen(url) as resp:
            return resp.read()
    except urllib.error.URLError:
        try:
            no_ssl = ssl._create_unverified_context()
            with urllib.request.urlopen(url, context=no_ssl) as resp:
                return resp.read()
        except Exception as e2:
            echo(f"Error fetching {url}: {e2}")
            return None

def load_index():
    data = fetch_url(REPO_URL)
    if not data:
        echo("Failed to fetch package index.")
        sys.exit(1)
    return json.loads(data.decode("utf-8"))

def ensure_path():
    plat = get_platform_key()
    if plat in ("linux","darwin"):
        rc_file = os.path.expanduser("~/.bashrc")
        if not os.path.exists(rc_file):
            rc_file = os.path.expanduser("~/.zshrc")
        export_line = f'export PATH="{BIN_DIR}:$PATH"'
        with open(rc_file, "a") as f:
            f.write(f"\n# Added by Cheese\n{export_line}\n")
    else:
        pass

def extract_zip(data, target):
    if os.path.exists(target):
        shutil.rmtree(target)
    os.makedirs(target, exist_ok=True)
    with zipfile.ZipFile(io.BytesIO(data)) as zf:
        zf.extractall(target)

def link_bin_entries(pkg, pkg_dir):
    bin_src = os.path.join(pkg_dir, "bin")
    if not os.path.isdir(bin_src): return
    for entry in os.listdir(bin_src):
        full = os.path.join(bin_src, entry)
        target = os.path.join(BIN_DIR, entry)
        if os.path.exists(target): os.remove(target)
        try:
            os.symlink(full, target)
        except OSError:
            shutil.copy2(full, target)

def pull(package):
    index = load_index()
    if package not in index:
        echo(f"Package '{package}' not found.")
        return
    plat = get_platform_key()
    url = index[package]["platforms"].get(plat)
    if not url:
        echo(f"No build for {plat}.")
        return
    echo(f"Downloading {package}...")
    data = fetch_url(url)
    if not data:
        echo("Download failed.")
        return
    pkg_dir = os.path.join(PACKAGES_DIR, package)
    extract_zip(data, pkg_dir)
    link_bin_entries(package, pkg_dir)
    installed = load_installed()
    installed[package] = index[package]["version"]
    save_installed(installed)
    echo(f"{package} installed successfully!")
    ensure_path()

def list_packages():
    installed = load_installed()
    if not installed:
        echo("No packages installed.")
        return
    for pkg, ver in installed.items():
        print(f"{pkg} ({ver})")

def delete_package(package):
    installed = load_installed()
    if package not in installed:
        echo(f"Package '{package}' not installed.")
        return
    pkg_dir = os.path.join(PACKAGES_DIR, package)
    if os.path.exists(pkg_dir):
        shutil.rmtree(pkg_dir)
    del installed[package]
    save_installed(installed)
    echo(f"{package} removed.")

def update_cli():
    echo("Updating Cheese CLI...")
    data = fetch_url(CHEESE_CLI_URL)
    if not data:
        echo("Failed to fetch the latest Cheese CLI.")
        return
    with open(CLI_PATH, "wb") as f:
        f.write(data)
    os.chmod(CLI_PATH, 0o755)
    echo("Cheese CLI updated successfully!")

def about():
    echo("Cheese ðŸ§€ - A Cross-Platform Package Manager")
    echo("Created by LightingDev AKA Yixuan")
    echo("https://github.com/LightingDev/cheese")
    echo("Open-source and community-driven!")

def main():
    parser = argparse.ArgumentParser(prog="cheese", add_help=False)
    parser.add_argument("cmd", nargs="?", help="Command to run")
    parser.add_argument("arg", nargs="?")
    args = parser.parse_args()

    if args.cmd == "pull":
        pull(args.arg)
    elif args.cmd == "del":
        delete_package(args.arg)
    elif args.cmd == "list":
        list_packages()
    elif args.cmd == "about":
        about()
    elif args.cmd == "update":
        update_cli()
    else:
        echo("Cheese CLI:")
        echo("  cheese pull <package>  - Install a package")
        echo("  cheese del <package>   - Remove a package")
        echo("  cheese list            - List installed packages")
        echo("  cheese update        - Update the Cheese CLI")
        echo("  cheese about       - Show about")

if __name__ == "__main__":
    main()
